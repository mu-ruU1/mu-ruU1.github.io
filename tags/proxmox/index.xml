<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>proxmox on Yuuのブログ</title><link>https://takag.me/tags/proxmox/</link><description>Recent content in proxmox on Yuuのブログ</description><generator>Hugo -- gohugo.io</generator><language>ja</language><lastBuildDate>Fri, 30 Dec 2022 16:04:42 +0900</lastBuildDate><atom:link href="https://takag.me/tags/proxmox/index.xml" rel="self" type="application/rss+xml"/><item><title>SoftEther VPNをProxmoxで構築する</title><link>https://takag.me/p/softether-vpn%E3%82%92proxmox%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B/</link><pubDate>Fri, 30 Dec 2022 16:04:42 +0900</pubDate><guid>https://takag.me/p/softether-vpn%E3%82%92proxmox%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B/</guid><description>&lt;img src="https://takag.me/img/2022/12-30/proxmox.svg" alt="Featured image of post SoftEther VPNをProxmoxで構築する" />&lt;h2 id="はじめに">はじめに&lt;/h2>
&lt;p>外出中に自宅のネットワークにアクセスしたいことがある。&lt;br>
そういった場合に VPN を利用することでローカルネットワークへのリモートアクセスが可能になる。&lt;br>
そこで今回は &lt;a class="link" href="https://ja.softether.org/" target="_blank" rel="noopener"
>SoftEther VPN&lt;/a> を使用した。&lt;/p>
&lt;h2 id="手順">手順&lt;/h2>
&lt;h3 id="proxmox-ve">Proxmox VE&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.proxmox.com/en/" target="_blank" rel="noopener"
>Proxmox VE&lt;/a>で VM の作成で気をつけることが 1 つある。&lt;br>
デフォルトのネットワークデバイスのモデルは&lt;code>VirtIO (準仮想化)&lt;/code>だと思うが、&lt;code>Intel E1000&lt;/code>に変更するする必要がある。&lt;br>
これをしないと、上り下りのスループットが 3Mbps 程しか出ない。&lt;/p>
&lt;p>&lt;img src="https://takag.me/img/2022/12-30/net-device.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="softether-vpn">SoftEther VPN&lt;/h3>
&lt;h4 id="ダウンロード">ダウンロード&lt;/h4>
&lt;p>&lt;a class="link" href="https://code.launchpad.net/~paskal-07/&amp;#43;archive/ubuntu/softethervpn" target="_blank" rel="noopener"
>PPA&lt;/a> を使用してインストールもできるが、バージョンが古いので&lt;a class="link" href="https://ja.softether.org/5-download" target="_blank" rel="noopener"
>ダウンロードサイト&lt;/a>から手動で入れる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo apt install gcc make -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -O &amp;lt;ファイルのURL&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ tar xzvf &amp;lt;ファイル&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> vpnserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> ..
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo mv vpnserver /usr/local/softether
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /usr/local/softether/vpnserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ chmod &lt;span class="m">600&lt;/span> *
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ chmod &lt;span class="m">700&lt;/span> vpncmd vpnserver
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="systemd">Systemd&lt;/h4>
&lt;p>&lt;a class="link" href="https://github.com/SoftEtherVPN/SoftEtherVPN/blob/master/systemd/softether-vpnserver.service" target="_blank" rel="noopener"
>コレ&lt;/a>を参考に&lt;code>/etc/systemd/system/softether-vpnserver.service&lt;/code>を作成する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Unit]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">SoftEther VPN Server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">After&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">network.target auditd.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ConditionPathExists&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">!/usr/local/softether/vpnserver/do_not_run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">forking&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">TasksMax&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">infinity&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">EnvironmentFile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-/usr/local/softether/vpnserver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/usr/local/softether/vpnserver/vpnserver start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStop&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/usr/local/softether/vpnserver/vpnserver stop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">KillMode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Restart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">on-failure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Hardening&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">PrivateTmp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ProtectHome&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ProtectSystem&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">full&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ReadOnlyDirectories&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ReadWriteDirectories&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-/usr/local/softether/vpnserver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">CapabilityBoundingSet&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_BROADCAST CAP_NET_RAW CAP_SYS_NICE CAP_SYSLOG CAP_SETUID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Install]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">multi-user.target&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>その後&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo systemctl start softether-vpnserver.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo systemctl &lt;span class="nb">enable&lt;/span> softether-vpnserver.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo systemctl status softether-vpnserver.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>あとはサーバー管理ツール等で設定すれば完了です。&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://forum.vpngate.net/viewtopic.php?t=66972" target="_blank" rel="noopener"
>SoftEther speed is too slow&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>